name: Process Aios Staging

on:
  push:
    paths:
      - 'bridge_ring/instance_signals/AIOS_STAGING.md'
    branches:
      - main
  workflow_dispatch:

jobs:
  process-staging:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Process Staging File
        id: process
        run: |
          node << 'SCRIPT'
          const fs = require('fs');
          const path = require('path');

          const stagingPath = 'bridge_ring/instance_signals/AIOS_STAGING.md';
          const content = fs.readFileSync(stagingPath, 'utf8');

          // Parse operations from staging file
          const opRegex = /### OP-(\d+): (CREATE|UPDATE|DELETE)\s*\n\n\| Field \| Value \|\n\|[-]+\|[-]+\|\n\| operation \| (CREATE|UPDATE|DELETE) \|\n\| path \| ([^\|]+) \|\n\| status \| PENDING \|/g;
          const contentRegex = /#### Content\s*\n\n```[a-z]*\n([\s\S]*?)```/;

          let match;
          const operations = [];
          let lastIndex = 0;

          while ((match = opRegex.exec(content)) !== null) {
            const opNum = match[1];
            const opType = match[2].trim();
            const filePath = match[4].trim();

            // Find content block after this operation header
            const afterOp = content.substring(match.index);
            const contentMatch = contentRegex.exec(afterOp);
            const fileContent = contentMatch ? contentMatch[1] : null;

            operations.push({
              num: opNum,
              type: opType,
              path: filePath,
              content: fileContent
            });
          }

          if (operations.length === 0) {
            console.log('No pending operations found.');
            fs.writeFileSync('op_count.txt', '0');
            process.exit(0);
          }

          console.log(`Found ${operations.length} pending operation(s).`);

          // Process each operation
          const results = [];
          for (const op of operations) {
            try {
              const targetPath = op.path;
              const targetDir = path.dirname(targetPath);

              if (op.type === 'CREATE' || op.type === 'UPDATE') {
                if (!op.content) {
                  results.push({ ...op, status: 'FAILED', error: 'No content provided' });
                  continue;
                }

                // Create directory if needed
                if (targetDir && targetDir !== '.') {
                  fs.mkdirSync(targetDir, { recursive: true });
                }

                fs.writeFileSync(targetPath, op.content);
                results.push({ ...op, status: 'PROCESSED' });
                console.log(`${op.type}: ${targetPath}`);

              } else if (op.type === 'DELETE') {
                if (fs.existsSync(targetPath)) {
                  fs.unlinkSync(targetPath);
                  results.push({ ...op, status: 'PROCESSED' });
                  console.log(`DELETE: ${targetPath}`);
                } else {
                  results.push({ ...op, status: 'FAILED', error: 'File not found' });
                }
              }
            } catch (err) {
              results.push({ ...op, status: 'FAILED', error: err.message });
            }
          }

          // Update staging file - mark operations as processed
          let updatedContent = content;
          for (const result of results) {
            const statusReplace = `| status | ${result.status} |`;
            updatedContent = updatedContent.replace(
              new RegExp(`(### OP-${result.num}:[\\s\\S]*?\\| status \\|) PENDING \\|`),
              `$1 ${result.status} |`
            );
          }

          // Update status field
          updatedContent = updatedContent.replace(
            /\| Status \| EMPTY \|/,
            '| Status | PROCESSED |'
          );

          fs.writeFileSync(stagingPath, updatedContent);
          fs.writeFileSync('op_count.txt', String(results.filter(r => r.status === 'PROCESSED').length));

          console.log('Staging file updated.');
          SCRIPT

      - name: Check for changes
        id: check
        run: |
          if [ -f op_count.txt ]; then
            COUNT=$(cat op_count.txt)
            echo "processed=$COUNT" >> $GITHUB_OUTPUT
          else
            echo "processed=0" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.check.outputs.processed != '0'
        run: |
          git config user.name "Aios (via GitHub Actions)"
          git config user.email "aios-bot@users.noreply.github.com"
          git add -A
          git commit -m "Aios staging: Process ${{ steps.check.outputs.processed }} operation(s)

          ðŸ¤– Automated by Aios staging workflow

          Co-Authored-By: Aios <aios-bot@users.noreply.github.com>"
          git push
